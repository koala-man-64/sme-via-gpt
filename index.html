<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Local RAG Chatbot</title>
  <style>
    :root {
      --bg: #f7f5ef;
      --panel: #ffffff;
      --ink: #1a1a1a;
      --muted: #5d5d5d;
      --line: #1d1d1d;
      --line-soft: #b8b8b8;
      --accent: #0f766e;

      --gap-layout: 16px;
      --spacing-panel: 12px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "JetBrains Mono", "IBM Plex Mono", "Fira Mono", "Source Code Pro", "Menlo", "Consolas", monospace;
      margin: 0;
      color: var(--ink);
      background: var(--bg);
      background-image:
        repeating-linear-gradient(0deg, transparent, transparent 23px, rgba(0, 0, 0, 0.04) 24px),
        repeating-linear-gradient(90deg, transparent, transparent 23px, rgba(0, 0, 0, 0.04) 24px);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: var(--spacing-panel) var(--gap-layout);
      background: var(--panel);
      border-bottom: 2px solid var(--line);
      display: flex;
      align-items: center;
      flex-shrink: 0;
    }

    header b {
      font-size: 14px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    #app-grid {
      flex: 1;
      display: grid;
      grid-template-columns: 280px 1fr 300px;
      gap: var(--gap-layout);
      padding: var(--gap-layout);
      min-height: 0;
      /* allows grid children to scroll */
      max-width: 1800px;
      margin: 0 auto;
      width: 100%;
    }

    .col {
      display: flex;
      flex-direction: column;
      gap: var(--gap-layout);
      min-height: 0;
    }

    .col-center {
      min-width: 0;
    }

    .panel {
      background: var(--panel);
      border: 2px solid var(--line);
      display: flex;
      flex-direction: column;
    }

    .panel-header {
      padding: var(--spacing-panel);
      border-bottom: 2px solid var(--line);
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .panel-title {
      font-size: 11px;
      font-weight: bold;
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }

    .panel-body {
      padding: var(--spacing-panel);
      overflow-y: auto;
      flex: 1;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      padding: 4px 0;
      border-bottom: 1px dashed var(--line-soft);
    }

    .stat-row:last-child {
      border-bottom: none;
    }

    .stat-label {
      color: var(--muted);
    }

    .stat-val {
      font-weight: bold;
      text-align: right;
    }

    #chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      border: 2px solid var(--line);
      background: var(--panel);
      min-height: 0;
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: var(--spacing-panel);
    }

    .msg {
      margin: 12px 0;
      display: flex;
    }

    .msg .bubble {
      padding: 10px 12px;
      max-width: 85%;
      white-space: pre-wrap;
      line-height: 1.4;
      border: 2px solid var(--line);
      font-size: 13px;
    }

    .user {
      justify-content: flex-end;
    }

    .user .bubble {
      background: #efefef;
    }

    .assistant {
      justify-content: flex-start;
    }

    .assistant .bubble {
      background: #ffffff;
      border-style: dashed;
    }

    #input-area {
      padding: var(--spacing-panel);
      border-top: 2px solid var(--line);
      background: var(--panel);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #bar {
      display: flex;
      gap: 8px;
    }

    #input {
      flex: 1;
      padding: 10px;
      border: 2px solid var(--line);
      outline: none;
      font-family: inherit;
    }

    #input {
      flex: 1;
      padding: 10px;
      border: 2px solid var(--line);
      outline: none;
      font-family: inherit;
      resize: none;
      /* No manual resize */
      height: 50px;
      min-height: 50px;
      max-height: 400px;
      overflow-y: hidden;
      /* Hide scrollbar when auto-expanding */
    }

    #input:focus {
      border-color: var(--accent);
    }

    /* Show scrollbar if max-height reached */
    #input.scrolling {
      overflow-y: auto;
    }

    button {
      padding: 8px 12px;
      border: 2px solid var(--line);
      background: #fff;
      cursor: pointer;
      text-transform: uppercase;
      font-size: 10px;
      letter-spacing: 0.1em;
      font-weight: bold;
    }

    button:hover {
      background: #f2f2f2;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .doc-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .doc-item {
      display: grid;
      grid-template-columns: 20px 1fr;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--line-soft);
      padding: 6px;
      background: #fafafa;
    }

    .doc-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
      overflow: hidden;
    }

    .doc-name {
      font-size: 11px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: bold;
    }

    .doc-meta {
      font-size: 10px;
      color: var(--muted);
    }

    #authMask {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(247, 245, 239, 0.95);
      z-index: 999;
    }

    #authMask.active {
      display: flex;
    }

    #authPanel {
      padding: 20px;
      background: #fff;
      border: 2px solid var(--line);
      width: 300px;
    }

    /* Tree View Styles */
    details {
      margin-bottom: 4px;
      border: 1px solid transparent;
      border-radius: 4px;
    }

    details[open] {
      border-color: var(--line-soft);
      background: var(--bg-warm);
    }

    summary {
      cursor: pointer;
      padding: 4px 8px;
      font-size: 11px;
      font-weight: 500;
      user-select: none;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      outline: none;
    }

    summary:hover {
      background: var(--line-soft);
    }

    summary::-webkit-details-marker {
      color: var(--muted);
    }

    .tree-msgs {
      list-style: none;
      padding: 0 0 0 16px;
      margin: 4px 0;
    }

    .tree-msgs li {
      font-size: 10px;
      color: #555;
      padding: 2px 0;
      border-left: 1px solid var(--line);
      padding-left: 6px;
      margin-bottom: 2px;
      cursor: pointer;
    }

    .tree-msgs li:hover {
      color: var(--text);
      background: rgba(0, 0, 0, 0.03);
    }

    .load-chat-btn {
      font-size: 9px;
      color: var(--accent);
      cursor: pointer;
      margin-left: 16px;
      margin-bottom: 4px;
      display: inline-block;
    }

    @media (max-width: 900px) {
      .mobile-only {
        display: inline-block !important;
        margin-right: 12px;
      }

      header {
        flex-wrap: wrap;
        gap: 8px;
        padding-bottom: 8px;
        /* Extra space for nav */
      }

      #mobile-nav {
        display: flex !important;
        width: 100%;
        padding-top: 8px;
        border-top: 1px dashed var(--line-soft);
        justify-content: space-around;
        order: 99;
        /* Force to bottom of header */
      }

      #app-grid {
        display: block;
        height: calc(100vh - 90px);
        /* Approx header height */
        overflow: hidden;
        padding: 0;
        /* Remove padding on mobile for full width */
      }

      .col,
      .col-center {
        width: 100%;
        height: 100%;
        display: none;
        /* Managed by JS */
      }

      /* Reset specific overrides */
      #chat-container {
        height: 100%;
        border-left: none;
        border-right: none;
        border-bottom: none;
      }

      .panel {
        height: 100%;
      }
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .animated-dots::after {
      content: '.';
      animation: dots 2s steps(4, end) infinite;
    }

    @keyframes dots {

      0%,
      20% {
        content: '';
      }

      40% {
        content: '.';
      }

      60% {
        content: '..';
      }

      80%,
      100% {
        content: '...';
      }
    }

    .hist-item {
      font-size: 11px;
      padding: 6px;
      border-bottom: 1px solid var(--line-soft);
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--muted);
    }

    .hist-item:hover {
      background: #f2f2f2;
      color: var(--ink);
    }

    .hist-item b {
      color: var(--ink);
      margin-right: 4px;
    }

    /* Tooltip (HTML based) */
    .has-tooltip {
      position: relative;
    }

    .tooltip-popup {
      display: none;
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #1a1a1a;
      color: #fff;
      padding: 8px 10px;
      border-radius: 4px;
      font-size: 11px;
      width: 220px;
      z-index: 1000;
      margin-bottom: 8px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      line-height: 1.4;
      font-weight: normal;
      /* reset from bold label */
      cursor: auto;
    }

    .has-tooltip:hover .tooltip-popup {
      display: block;
    }

    /* arrow */
    .tooltip-popup::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #1a1a1a transparent transparent transparent;
    }

    /* Right-sided tooltip for sidebar */
    .tooltip-right {
      bottom: auto !important;
      left: 100% !important;
      top: 50% !important;
      transform: translateY(-50%) !important;
      margin-left: 10px !important;
      margin-bottom: 0 !important;
    }

    .tooltip-right::after {
      top: 50% !important;
      left: auto !important;
      right: 100% !important;
      margin-left: 0 !important;
      margin-top: -5px !important;
      border-color: transparent #1a1a1a transparent transparent !important;
    }

    /* Markdown Compact Styles */
    .bubble p {
      margin: 6px 0;
    }

    .bubble p:first-child {
      margin-top: 0;
    }

    .bubble p:last-child {
      margin-bottom: 0;
    }

    .bubble ul,
    .bubble ol {
      margin: 6px 0;
      padding-left: 20px;
    }

    .bubble li {
      margin: 2px 0;
    }

    .bubble pre {
      background: #f1f1f1;
      padding: 8px;
      border-radius: 4px;
      overflow-x: auto;
      margin: 8px 0;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body>
  <div id="authMask">
    <div id="authPanel">
      <div class="panel-title" style="margin-bottom:12px">Unlock</div>
      <div class="row" style="display:flex; gap:8px;">
        <input id="authInput" type="password" placeholder="Password" />
        <button id="authBtn">Go</button>
      </div>
      <div id="authError"></div>
    </div>
  </div>

  <header>
    <b>Local RAG Chatbot</b>

    <div id="mobile-nav" style="display:none; gap:12px; font-size:11px; font-weight:bold; text-transform:uppercase;">
      <span id="nav-model" onclick="setMobileTab('model')" style="cursor:pointer; opacity:0.5">Model</span>
      <span id="nav-chat" onclick="setMobileTab('chat')" style="cursor:pointer; text-decoration:underline">Chat</span>
      <span id="nav-docs" onclick="setMobileTab('docs')" style="cursor:pointer; opacity:0.5">Docs</span>
    </div>
  </header>

  <div id="app-grid">
    <!-- LEFT PANEL: Stats -->
    <aside class="col" id="panel-left">
      <div class="panel" style="flex:0 0 auto">
        <div class="panel-header"><span class="panel-title">Model</span></div>
        <div class="panel-body">
          <select id="modelSelect"
            style="width:100%; font-size:12px; padding:6px; border:1px solid var(--line-soft); border-radius:4px; background:#fff; outline:none; margin-bottom:8px;">
            <option value="" disabled selected>Loading...</option>
          </select>
          <div id="modelDesc" style="font-size:11px; color:#555; margin-bottom:8px; line-height:1.4;"></div>
          <div id="modelPrices"
            style="font-size:11px; color:var(--muted); background:var(--bg-warm); padding:6px; border-radius:4px;">
          </div>
        </div>
      </div>

      <div class="panel" style="flex:1">
        <div class="panel-header"><span class="panel-title">Context Window</span></div>
        <div class="panel-body" style="overflow:visible; display:flex; flex-direction:column;">
          <div class="stat-row" style="flex-wrap:wrap;">
            <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
              <span class="stat-label has-tooltip" style="cursor:help">Total Tokens
                <div class="tooltip-popup tooltip-right">Total tokens sent to the API (Input). Progress shows saturation
                  of context window.</div>
              </span>
              <span class="stat-val" id="usageTokens">-</span>
            </div>
            <!-- Progress Bar -->
            <div
              style="width:100%; height:4px; background:#e0e0e0; margin-top:4px; border-radius:2px; overflow:hidden;">
              <div id="usageBar"
                style="width:0%; height:100%; background:var(--accent); transition: width 0.3s, background 0.3s;"></div>
            </div>
          </div>
          <div class="stat-row">
            <span class="stat-label has-tooltip" style="cursor:help">Avg Cached
              <div class="tooltip-popup tooltip-right">Average number of RAG chunks (or equiv. text) hitting the Prompt
                Cache per
                message turn.</div>
            </span>
            <span class="stat-val" id="usageCacheAvg">-</span>
          </div>
          <div class="stat-row">
            <span class="stat-label has-tooltip" style="cursor:help">Output
              <div class="tooltip-popup tooltip-right">Tokens generated by the model (Assistant response).</div>
            </span>
            <span class="stat-val" id="usageOutput">-</span>
          </div>
          <!-- Granular Breakdown -->
          <div class="stat-row">
            <span class="stat-label has-tooltip" style="cursor:help">User Msg
              <div class="tooltip-popup tooltip-right">Tokens consumed by your latest question.</div>
            </span>
            <span class="stat-val" id="usageQuery">-</span>
          </div>
          <div class="stat-row">
            <span class="stat-label has-tooltip" style="cursor:help">Context
              <div class="tooltip-popup tooltip-right">Tokens used by retrieved documents or full context text.</div>
            </span>
            <span class="stat-val" id="usageContext">-</span>
          </div>
          <div class="stat-row">
            <span class="stat-label has-tooltip" style="cursor:help">History
              <div class="tooltip-popup tooltip-right">Tokens consumed by previous conversation turns (User + Bot).
              </div>
            </span>
            <span class="stat-val" id="usageHistory">-</span>
          </div>
          <div class="stat-row">
            <span class="stat-label has-tooltip" style="cursor:help">System
              <div class="tooltip-popup tooltip-right">Tokens used by the static system instructions.</div>
            </span>
            <span class="stat-val" id="usageSystem">-</span>
          </div>

          <div
            style="margin-top:12px; margin-bottom:4px; font-size:10px; color:var(--muted); text-transform:uppercase; letter-spacing:0.05em;">
            Saved Chats</div>
          <div id="historyList"
            style="border:1px solid var(--line-soft); flex:1; overflow-y:auto; min-height:100px; background:#fff;">
          </div>
        </div>
      </div>
    </aside>

    <!-- CENTER PANEL: Chat -->
    <main class="col col-center" id="panel-center">
      <div id="chat-container">
        <!-- HEADER -->
        <div class="panel-header"
          style="flex:0 0 auto; background:var(--panel); border-bottom:2px solid var(--line); padding:var(--spacing-panel); display:flex; justify-content:space-between; align-items:center;">
          <div style="display:flex; align-items:center;">
            <button id="mobileBackBtn" class="mobile-only"
              style="display:none; padding:4px 8px; font-size:14px; margin-right:8px;"
              onclick="setMobileTab('model')">←</button>
            <span class="panel-title">Chat</span>
          </div>
          <button id="newChatBtn" onclick="startNewChat()">NEW CHAT</button>
        </div>
        <div id="chat"></div>
        <div id="input-area">
          <div id="bar">
            <textarea id="input" placeholder="Type your question..." rows="1"></textarea>
            <button id="send">SEND</button>
          </div>
        </div>
      </div>
    </main>

    <!-- RIGHT PANEL: Docs -->
    <aside class="col" id="panel-right">
      <div class="panel" style="flex:1; display:flex; flex-direction:column; min-height:0;">
        <div class="panel-header">
          <span class="panel-title">Knowledge Base</span>
        </div>

        <!-- MODE SELECTOR -->
        <div style="padding:var(--spacing-panel); border-bottom:2px solid var(--line);">
          <div
            style="font-size:10px; font-weight:bold; margin-bottom:8px; text-transform:uppercase; letter-spacing:0.05em; color:var(--muted);">
            Chat Mode</div>
          <div style="display:flex; flex-direction:column; gap:6px;">
            <label class="has-tooltip"
              style="display:flex; align-items:center; gap:8px; font-size:12px; cursor:pointer; width:fit-content;">
              <input type="radio" name="chatMode" value="direct">
              <b>Direct</b> <span class="muted" style="margin-left:auto; font-size:10px;">(Full Context)</span>
              <div class="tooltip-popup">Injects FULL context of ALL selected files.<br />Best for comprehensive answers
                using entire documents.</div>
            </label>
            <label class="has-tooltip"
              style="display:flex; align-items:center; gap:8px; font-size:12px; cursor:pointer; width:fit-content;">
              <input type="radio" name="chatMode" value="cache">
              <b>Cache</b> <span class="muted" style="margin-left:auto; font-size:10px;">(Optimized Prefix)</span>
              <div class="tooltip-popup">Pins ALL files to the top of the prompt (System -> Context ->
                History).<br />Max cache hits; best for multiple questions on stable docs.</div>
            </label>
            <label class="has-tooltip"
              style="display:flex; align-items:center; gap:8px; font-size:12px; cursor:pointer; width:fit-content;">
              <input type="radio" name="chatMode" value="rag" checked>
              <b>RAG</b> <span class="muted" style="margin-left:auto; font-size:10px;">(Retrieval)</span>
              <div class="tooltip-popup">Retrieves only relevant chunks based on your question.<br />Best for large
                knowledge bases exceeding context limits.</div>
            </label>
          </div>
        </div>

        <div
          style="padding:calc(var(--spacing-panel) - 2px) var(--spacing-panel); border-bottom:2px solid var(--line); background:#fafafa; display:flex; gap:6px; flex-wrap:wrap;">
          <button id="selectAllBtn" style="flex:1;">All</button>
          <button id="selectNoneBtn" style="flex:1;">None</button>
          <button id="reindexBtn" style="flex:1;">Reindex</button>
        </div>
        <div style="padding:4px var(--spacing-panel);">
          <div id="reindexOut" style="font-size:10px; color:var(--accent);"></div>
          <div class="muted" id="docsSummary" style="font-size:10px; margin-top:4px;"></div>
          <!-- Status Stats -->
          <div id="status" style="margin-top:8px; display:flex; flex-direction:column; gap:2px;"></div>
        </div>
        <div class="panel-body" id="docsList" style="padding:var(--spacing-panel);"></div>
      </div>
    </aside>
  </div>

  <script>
    const AUTH_REQUIRED = __AUTH_REQUIRED__;
    let conversationId = null;
    let docs = [];
    let selectedDocs = new Set();
    let appPassword = null;
    let msgCount = 0;

    function scrollToMsg(id) {
      const el = document.getElementById(id);
      if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function addMsg(role, text) {
      msgCount++;
      const msgId = 'msg-' + msgCount;

      const chat = document.getElementById('chat');
      const div = document.createElement('div');
      div.className = 'msg ' + (role === 'user' ? 'user' : 'assistant');
      div.id = msgId;

      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.innerHTML = marked.parse(text);
      div.appendChild(bubble);
      chat.appendChild(div);

      // Auto-scroll chat
      setTimeout(() => {
        chat.scrollTop = chat.scrollHeight;
      }, 10);
    }

    function setUsageInfo(info) {
      if (!info) return;

      // Tokens: Use actual if available, else estimate
      const total = info.actual_prompt_tokens || info.context_tokens_estimated || 0;
      const limit = info.model_limit || 128000;

      const txtEl = document.getElementById('usageTokens');
      if (info.actual_prompt_tokens) {
        txtEl.textContent = formatNumber(total) + ' (Actual)';
      } else {
        txtEl.textContent = formatNumber(total) + ' (Est)';
      }

      // Update Bar
      const pct = Math.min(100, Math.max(0, (total / limit) * 100));
      const bar = document.getElementById('usageBar');
      bar.style.width = pct + '%';

      // Color coding
      if (pct < 50) bar.style.background = 'var(--accent)'; // Green-ish (teal)
      else if (pct < 80) bar.style.background = '#eab308'; // Yellow
      else bar.style.background = '#ef4444'; // Red

      document.getElementById('usageCacheAvg').textContent = info.avg_cached_chunks !== undefined ? info.avg_cached_chunks : '-';
      document.getElementById('usageOutput').textContent = info.completion_tokens !== undefined ? formatNumber(info.completion_tokens) : '-';

      if (info.breakdown) {
        document.getElementById('usageQuery').textContent = formatNumber(info.breakdown.query);
        document.getElementById('usageContext').textContent = formatNumber(info.breakdown.context);
        document.getElementById('usageHistory').textContent = formatNumber(info.breakdown.history);
        document.getElementById('usageSystem').textContent = formatNumber(info.breakdown.system);
      }
      console.log("setUsageInfo: updated UI", info);
    }

    function showAuthMask(message) {
      const mask = document.getElementById('authMask');
      if (!mask) return;
      mask.classList.add('active');
      const error = document.getElementById('authError');
      if (error) {
        error.textContent = message || '';
      }
      const input = document.getElementById('authInput');
      if (input) input.focus();
    }

    function hideAuthMask() {
      const mask = document.getElementById('authMask');
      if (mask) mask.classList.remove('active');
      const error = document.getElementById('authError');
      if (error) error.textContent = '';
    }

    function ensureAuth() {
      if (!AUTH_REQUIRED) return true;
      if (appPassword) return true;
      showAuthMask('Password required.');
      return false;
    }

    async function fetchWithAuth(url, options = {}) {
      const headers = Object.assign({}, options.headers || {});
      if (appPassword) {
        headers['X-App-Password'] = appPassword;
      }
      console.log(`fetchWithAuth: ${options.method || 'GET'} ${url}`);
      const r = await fetch(url, { ...options, headers });
      console.log(`fetchWithAuth: ${url} status ${r.status}`);
      if (r.status === 401) {
        appPassword = null;
        showAuthMask('Password required.');
        throw new Error('Unauthorized');
      }
      return r;
    }

    async function attemptAuth() {
      const input = document.getElementById('authInput');
      const btn = document.getElementById('authBtn');
      const password = input ? input.value.trim() : '';
      if (!password) {
        showAuthMask('Enter a password to continue.');
        return;
      }
      if (btn) btn.disabled = true;
      try {
        const r = await fetch('/api/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });
        if (!r.ok) {
          showAuthMask('Incorrect password.');
          return;
        }
        appPassword = password;
        if (input) input.value = '';
        hideAuthMask();
        await refreshStatus();
        await loadDocs();
        await loadModels(); // Models
      } catch (err) {
        showAuthMask('Unable to authenticate.');
      } finally {
        if (btn) btn.disabled = false;
      }
    }

    function formatBytes(value) {
      if (!value && value !== 0) return '';
      const units = ['B', 'KB', 'MB', 'GB', 'TB'];
      let size = Number(value);
      let i = 0;
      while (size >= 1024 && i < units.length - 1) {
        size /= 1024;
        i += 1;
      }
      return `${size.toFixed(size >= 10 || i === 0 ? 0 : 1)}${units[i]}`;
    }

    function formatNumber(value) {
      if (value === null || value === undefined) return '0';
      if (typeof value === 'number') {
        return Number.isFinite(value) ? value.toLocaleString() : '0';
      }
      return String(value);
    }

    function updateDocsSummary() {
      const el = document.getElementById('docsSummary');
      if (!el) return;
      el.textContent = `${selectedDocs.size} selected`;
    }

    function renderDocs() {
      const list = document.getElementById('docsList');
      if (!list) return;
      list.innerHTML = '';

      if (!docs.length) {
        list.innerHTML = '<div style="font-size:11px; color:#999; text-align:center; padding:20px;">No documents found.</div>';
        updateDocsSummary();
        return;
      }

      docs.forEach((doc) => {
        const row = document.createElement('label');
        row.className = 'doc-item';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = selectedDocs.has(doc.name);
        checkbox.addEventListener('change', () => {
          if (checkbox.checked) selectedDocs.add(doc.name);
          else selectedDocs.delete(doc.name);
          updateDocsSummary();
        });

        const info = document.createElement('div');
        info.className = 'doc-info';

        const name = document.createElement('span');
        name.className = 'doc-name';
        name.textContent = doc.name;

        const meta = document.createElement('span');
        meta.className = 'doc-meta';
        const parts = [];
        if (doc.cache_status) parts.push(doc.cache_status);
        if (doc.size) parts.push(formatBytes(doc.size));
        meta.textContent = parts.join(' | ');

        info.appendChild(name);
        info.appendChild(meta);

        row.appendChild(checkbox);
        row.appendChild(info);
        list.appendChild(row);
      });
      updateDocsSummary();
    }


    async function loadDocs() {
      console.log("loadDocs: called");
      if (!ensureAuth()) return;
      const list = document.getElementById('docsList');
      if (list) list.innerHTML = '<div style="padding:10px; font-size:11px;">Loading docs...</div>';

      try {
        const r = await fetchWithAuth('/api/docs');
        const j = await r.json();
        docs = j.docs || [];
        selectedDocs = new Set(j.selected || docs.filter(d => d.selected).map(d => d.name));
        renderDocs();
      } catch (err) {
        console.error("loadDocs error", err);
        docs = [];
        selectedDocs = new Set();
        renderDocs();
      }
    }

    function setAllDocs(selected) {
      if (selected) {
        selectedDocs = new Set(docs.map(d => d.name));
      } else {
        selectedDocs = new Set();
      }
      renderDocs();
      // Also trigger render to show checkboxes correctly
      // (renderDocs does this)
    }



    let modelsData = {};

    async function loadModels() {
      console.log("loadModels: called");
      if (!ensureAuth()) {
        console.log("loadModels: auth not valid");
        return;
      }
      try {
        console.log("loadModels: fetching /api/models");
        const r = await fetchWithAuth('/api/models');
        console.log("loadModels: response status", r.status);
        const j = await r.json();
        console.log("loadModels: data", j);
        const sel = document.getElementById('modelSelect');
        sel.innerHTML = '';

        modelsData = {};
        j.models.forEach(m => {
          modelsData[m.id] = m;
          const opt = document.createElement('option');
          opt.value = m.id;
          opt.textContent = m.name;
          if (m.id === j.default) opt.selected = true;
          sel.appendChild(opt);
        });

        sel.addEventListener('change', updateModelDisplay);
        updateModelDisplay();
      } catch (err) {
        console.error("Failed to load models", err);
        const sel = document.getElementById('modelSelect');
        if (sel) {
          sel.innerHTML = '<option disabled selected>Error loading models</option>';
        }
      }
    }

    function updateModelDisplay() {
      const id = document.getElementById('modelSelect').value;
      const m = modelsData[id];
      if (!m) return;

      document.getElementById('modelDesc').textContent = m.desc.split('(')[0].trim();

      const fmtPrice = (p) => p !== undefined ? '$' + p.toFixed(2) : '-';
      document.getElementById('modelPrices').innerHTML =
        `<b>Input:</b> ${fmtPrice(m.price_in)} / 1M<br/>` +
        `<b>Cached:</b> ${fmtPrice(m.price_cache)} / 1M<br/>` +
        `<b>Output:</b> ${fmtPrice(m.price_out)} / 1M`;
    }

    async function refreshStatus() {
      console.log("refreshStatus: called");
      if (!ensureAuth()) return;
      try { // Added try/catch for logging
        const r = await fetchWithAuth('/api/status');
        const j = await r.json();
        console.log("refreshStatus: header", j);

        // Build vertical list
        const rows = [
          { label: 'Status', val: j.ready ? 'Online' : 'Not built' },
          { label: 'Blobs', val: formatNumber(j.blobs) },
          { label: 'Chunks', val: formatNumber(j.chunks) },
          { label: 'Tokens', val: formatNumber(j.tokens) },
          { label: 'Dim', val: j.dim ?? '-' },
          { label: 'Model', val: j.model },
        ];

        const html = rows.map(r => `
        <div class="stat-row">
          <span class="stat-label">${r.label}</span>
          <span class="stat-val">${r.val}</span>
        </div>
      `).join('');

        document.getElementById('status').innerHTML = html;
      } catch (e) {
        console.error("refreshStatus failed", e);
      }
    }

    function addThinking() {
      removeThinking();
      const chat = document.getElementById('chat');
      const div = document.createElement('div');
      div.className = 'msg assistant';
      div.id = 'thinkingMsg';
      const bubble = document.createElement('div');
      bubble.className = 'bubble thinking';

      const text = document.createElement('span');
      text.textContent = 'Thinking';

      const dots = document.createElement('span');
      dots.className = 'animated-dots';

      bubble.appendChild(text);
      bubble.appendChild(dots);
      div.appendChild(bubble);
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function removeThinking() {
      const existing = document.getElementById('thinkingMsg');
      if (existing) existing.remove();
    }

    // TREE VIEW LOGIC

    async function loadConversationList() {
      try {
        const r = await fetchWithAuth('/api/conversations');
        if (!r.ok) return; // Silent fail
        const data = await r.json();
        const list = document.getElementById('historyList');
        if (!list) return;
        list.innerHTML = '';

        if (!data.sessions || data.sessions.length === 0) {
          list.innerHTML = '<div style="padding:8px; color:var(--muted); font-size:11px;">No saved chats.</div>';
          return;
        }

        data.sessions.forEach(s => {
          const det = document.createElement('details');
          det.id = 'tree-' + s.id;

          const sum = document.createElement('summary');
          // Format date slightly
          const d = s.last_modified ? new Date(s.last_modified).toLocaleString() : s.id.substring(0, 8);
          sum.textContent = d;
          sum.title = s.id;

          // Lazy load on toggle
          det.addEventListener('toggle', (e) => {
            if (det.open) onExpandChat(s.id, det);
          });

          det.appendChild(sum);
          list.appendChild(det);
        });

      } catch (e) {
        console.error("loadConversationList fail", e);
      }
    }

    async function onExpandChat(id, detailsEl) {
      if (detailsEl.dataset.loaded) return; // Already loaded

      const contentDiv = document.createElement('div');
      contentDiv.innerHTML = '<div style="padding:4px 16px; font-size:10px; color:var(--muted);">Loading...</div>';
      detailsEl.appendChild(contentDiv);

      try {
        const r = await fetchWithAuth('/api/history/' + id);
        if (!r.ok) throw new Error("Fetch fail");
        const data = await r.json();

        contentDiv.innerHTML = ''; // Clear loading

        // Load Button
        const btn = document.createElement('span');
        btn.className = 'load-chat-btn';
        btn.textContent = 'OPEN THIS CHAT';
        btn.onclick = () => {
          conversationId = id;
          localStorage.setItem("conversationId", id);
          loadHistory(id);
          if (window.innerWidth <= 900) setMobileTab('chat');
        };
        contentDiv.appendChild(btn);

        // Messages List
        const ul = document.createElement('ul');
        ul.className = 'tree-msgs';

        (data.history || []).forEach(msg => {
          const li = document.createElement('li');
          // Truncate
          const txt = msg.content.substring(0, 50) + (msg.content.length > 50 ? '...' : '');
          li.textContent = `${msg.role === 'user' ? 'U' : 'A'}: ${txt}`;
          li.title = msg.content;
          // Clicking a message could scroll to it if loaded, but for now just load the chat
          li.onclick = () => {
            conversationId = id;
            localStorage.setItem("conversationId", id);
            loadHistory(id);
            if (window.innerWidth <= 900) setMobileTab('chat');
          };
          ul.appendChild(li);
        });

        contentDiv.appendChild(ul);
        detailsEl.dataset.loaded = "true";

      } catch (e) {
        contentDiv.innerHTML = '<div style="padding:4px 16px; color:red; font-size:10px;">Error loading</div>';
      }
    }

    async function loadHistory(id) {
      try {
        console.log("Loading history for:", id);
        const r = await fetchWithAuth('/api/history/' + id);
        if (!r.ok) throw new Error("Failed to load history");
        const data = await r.json();

        // Clear existing
        document.getElementById('chat').innerHTML = '';
        msgCount = 0;

        // Render messages
        if (data.history && Array.isArray(data.history)) {
          data.history.forEach(msg => {
            addMsg(msg.role, msg.content);
          });
        }

        // Restore selected docs
        if (data.selected_blobs && Array.isArray(data.selected_blobs)) {
          selectedDocs = new Set(data.selected_blobs);
          renderDocs();
        }

        console.log("History loaded. Msg count:", msgCount);
      } catch (e) {
        console.error("loadHistory failed", e);
        // If invalid, clear ID
        localStorage.removeItem("conversationId");
        conversationId = null;
      }
    }

    function startNewChat() {
      conversationId = null;
      localStorage.removeItem("conversationId");
      document.getElementById('chat').innerHTML = '';
      const hist = document.getElementById('historyList');
      if (hist) hist.innerHTML = '';
      msgCount = 0;
      setUsageInfo(null);
      selectedDocs.clear(); // Optional: do we want to clear selection? Proposed plan said reset.
      renderDocs();
      addMsg('assistant', 'Started a new chat session.');
    }

    async function send() {
      const inp = document.getElementById('input');
      const text = inp.value.trim();
      if (!text) return;
      if (!ensureAuth()) return;

      // Get mode
      const mode = document.querySelector('input[name="chatMode"]:checked').value;
      const model = document.getElementById('modelSelect').value;

      inp.value = '';
      addMsg('user', text);
      addThinking();

      try {
        const r = await fetchWithAuth('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text, conversation_id: conversationId, mode: mode, model: model })
        });
        const j = await r.json();
        conversationId = j.conversation_id;
        localStorage.setItem("conversationId", conversationId);
        removeThinking();

        // Refresh list to show new updated time/chat
        // loadConversationList();

        // Answer
        addMsg('assistant', j.answer);

        // If sources, append them as a separate bubble or text?
        // Old app had setSources in separate div. Let's append to chat.
        if (j.sources && j.sources.length > 0) {
          const lines = j.sources.map(s => `• ${s.blob_name} (chunk ${s.chunk_id})`);
          const sourceText = "Sources:\n" + lines.join("\n");
          // Optional: add as system msg or just appended
          // Use a lighter bubble
          const chat = document.getElementById('chat');
          const sDiv = document.createElement('div');
          sDiv.className = 'msg assistant';
          sDiv.style.marginTop = '-8px';
          const sBub = document.createElement('div');
          sBub.className = 'bubble';
          sBub.style.fontSize = '11px';
          sBub.style.color = 'var(--muted)';
          sBub.textContent = sourceText;
          sDiv.appendChild(sBub);
          chat.appendChild(sDiv);
        }

        setUsageInfo(j.usage_info);
        console.log("send: success", j);
      } catch (err) {
        console.error("send: error", err);
        removeThinking();
        addMsg('assistant', 'Sorry, something went wrong while contacting the server.');
      }
    }

    const inpEl = document.getElementById('input');

    function autoResizeInput() {
      inpEl.style.height = 'auto';
      inpEl.style.height = inpEl.scrollHeight + 'px';
      if (inpEl.scrollHeight > 400) {
        inpEl.classList.add('scrolling');
      } else {
        inpEl.classList.remove('scrolling');
      }
    }

    inpEl.addEventListener('input', autoResizeInput);

    // Reset height on send
    const originalSend = send;
    // We need to hook into send or just rely on value clearing.
    // The send function clears inp.value, we should resize after.

    document.getElementById('send').addEventListener('click', () => {
      send().then(() => {
        inpEl.style.height = '50px';
        inpEl.classList.remove('scrolling');
      });
    });

    inpEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send().then(() => {
          inpEl.style.height = '50px';
          inpEl.classList.remove('scrolling');
        });
      }
    });

    document.getElementById('authBtn').addEventListener('click', attemptAuth);
    document.getElementById('authInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') attemptAuth();
    });

    document.getElementById('selectAllBtn').addEventListener('click', () => {
      setAllDocs(true);
    });

    document.getElementById('selectNoneBtn').addEventListener('click', () => {
      setAllDocs(false);
    });

    document.getElementById('reindexBtn').addEventListener('click', async () => {
      if (!ensureAuth()) return;
      const btn = document.getElementById('reindexBtn');
      btn.disabled = true;
      document.getElementById('reindexOut').textContent = 'Running...';
      try {
        const payload = { selected_blobs: Array.from(selectedDocs) };
        const r = await fetchWithAuth('/api/reindex', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        if (!j.ok) {
          document.getElementById('reindexOut').textContent = 'Error: ' + JSON.stringify(j);
        } else {
          document.getElementById('reindexOut').textContent = `Done. Indexed ${j.indexed_files} files in ${j.seconds}s`;
          await refreshStatus();
          await loadDocs();
        }
      } catch (err) {
        console.error("reindex: error", err);
        document.getElementById('reindexOut').textContent = 'Reindex failed.';
      } finally {
        btn.disabled = false;
      }
    });

    // ----------------------------------------------------
    // Mobile Tab Logic
    // ----------------------------------------------------
    function setMobileTab(tab) {
      if (window.innerWidth > 900) return;

      const pLeft = document.getElementById('panel-left');
      const pCenter = document.getElementById('panel-center');
      const pRight = document.getElementById('panel-right');

      // Default to hiding all
      if (pLeft) pLeft.style.display = 'none';
      if (pCenter) pCenter.style.display = 'none';
      if (pRight) pRight.style.display = 'none';

      // Show Target
      if (tab === 'model' && pLeft) pLeft.style.display = 'flex';
      if (tab === 'chat' && pCenter) pCenter.style.display = 'flex';
      if (tab === 'docs' && pRight) pRight.style.display = 'flex';

      // Update Nav Visuals
      ['model', 'chat', 'docs'].forEach(t => {
        const el = document.getElementById('nav-' + t);
        if (!el) return;
        if (t === tab) {
          el.style.opacity = '1';
          el.style.textDecoration = 'underline';
        } else {
          el.style.opacity = '0.5';
          el.style.textDecoration = 'none';
        }
      });
    }

    // Listen for resize to reset desktop state
    window.addEventListener('resize', () => {
      if (window.innerWidth > 900) {
        // Reset to desktop styles (remove inline display styles)
        const pLeft = document.getElementById('panel-left');
        const pCenter = document.getElementById('panel-center');
        const pRight = document.getElementById('panel-right');
        if (pLeft) pLeft.style.display = '';
        if (pCenter) pCenter.style.display = '';
        if (pRight) pRight.style.display = '';
      } else {
        // Apply current tab (heuristic: check nav state or default to chat)
        const active = document.querySelector('#mobile-nav span[style*="text-decoration: underline"]');
        const tab = active ? active.id.replace('nav-', '') : 'chat';
        setMobileTab(tab);
      }
    });

    // Initial Mobile Check
    if (window.innerWidth <= 900) {
      setMobileTab('chat');
    }

    // ----------------------------------------------------
    // Debug Logging Overlay
    // ----------------------------------------------------
    (function () {
      const debugDiv = document.createElement('div');
      debugDiv.id = 'debug-console';
      debugDiv.style.cssText = `
        position: fixed;
        bottom: 0;
        right: 0;
        width: 100%;
        height: 150px;
        background: rgba(0,0,0,0.85);
        color: #0f0;
        font-family: monospace;
        font-size: 10px;
        padding: 8px;
        overflow-y: auto;
        z-index: 9999;
        display: none; /* Hidden by default, toggle with double click on header */
        border-top: 1px solid #333;
      `;
      document.body.appendChild(debugDiv);

      const oldLog = console.log;
      const oldErr = console.error;

      function appendLog(type, args) {
        const line = document.createElement('div');
        line.style.color = type === 'ERR' ? '#ff6b6b' : '#0f0';
        line.style.borderBottom = '1px solid #333';
        line.textContent = `[${type}] ` + Array.from(args).map(a =>
          typeof a === 'object' ? JSON.stringify(a) : String(a)
        ).join(' ');
        debugDiv.appendChild(line);
        debugDiv.scrollTop = debugDiv.scrollHeight;
      }

      console.log = function (...args) {
        oldLog.apply(console, args);
        appendLog('LOG', args);
      };

      console.error = function (...args) {
        oldErr.apply(console, args);
        appendLog('ERR', args);
      };

      window.onerror = function (msg, url, line, col, error) {
        appendLog('FATAL', [msg, url, line, col, error]);
        // Force show if fatal error
        debugDiv.style.display = 'block';
      };

      // Toggle on Header Click
      document.querySelector('header').addEventListener('dblclick', () => {
        debugDiv.style.display = debugDiv.style.display === 'none' ? 'block' : 'none';
      });

      // Also show initially for now to help the user immediately
      // debugDiv.style.display = 'block'; 
      console.log("Debug Console Initialized (Hidden)");
    })();

    if (AUTH_REQUIRED) {
      showAuthMask('');
    } else {
      (async () => {
        try {
          console.log("Startup init via IIFE");
          // Run these partly in parallel or just sequentially but safely
          refreshStatus().catch(e => console.error("Startup: refreshStatus fail", e));
          loadDocs().catch(e => console.error("Startup: loadDocs fail", e));
          loadModels().catch(e => console.error("Startup: loadModels fail", e));

          // RESTORE CHAT
          const storedId = localStorage.getItem("conversationId");
          if (storedId) {
            conversationId = storedId;
            loadHistory(storedId).catch(e => console.error("Startup: loadHistory fail", e));
          }

          // Load Tree
          loadConversationList();

        } catch (e) { console.error("Startup IIFE fatal", e); }
      })();
    }
  </script>
</body>

</html>